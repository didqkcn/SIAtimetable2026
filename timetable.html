<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€í•™ ì‹œê°„í‘œ ë¹Œë”</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #c1272d;
            --bg-color: white;
            --border-color: #f5d5d6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        html, body { height: 100%; }
        body { background-color: var(--bg-color); color: #333; height: 100vh; overflow: hidden; }

        .app-container { display: flex; height: 100vh; width: 100vw; overflow: hidden; }
        
        @media (max-width: 1200px) {
            body { overflow: auto; }
            .app-container { height: auto; overflow: visible; }
        }

        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        .selected-panel {
            width: 300px;
            background: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 16px;
            overflow: hidden;
        }

        .selected-panel h3 {
            font-size: 1rem;
            color: var(--primary-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
        }

        .selected-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .selected-item {
            background: #ffffff;
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 4px;
            font-size: 0.85rem;
            position: relative;
            cursor: pointer;
        }

        .selected-item:hover {
            background: #ffe0e0;
        }

        .selected-item strong {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        .selected-item small {
            color: #666;
            font-size: 0.75rem;
        }

        .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .stats-box {
            background: #fff0f0;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .stats-row:last-child {
            margin-bottom: 0;
            padding-top: 6px;
            border-top: 1px solid #f5d5d6;
            font-weight: bold;
        }

        .save-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-btn:hover {
            background: #a01d23;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 39, 45, 0.3);
        }

        .save-status {
            text-align: center;
            font-size: 0.75rem;
            color: #666;
            margin-top: 6px;
            min-height: 16px;
        }

        .save-status.success {
            color: #4CAF50;
            font-weight: 600;
        }

        h2 { margin-bottom: 20px; font-size: 1.2rem; color: var(--primary-color); }

        .upload-section { margin-bottom: 12px; }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 999px;
            background: #f8fafc;
            color: #555;
            font-size: 0.85rem;
        }

        .filters { display: flex; gap: 10px; margin-bottom: 20px; }
        .filters select {
            flex: 1;
            padding: 10px;
            padding-right: 30px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            outline: none;
            background-position: right 8px center;
            background-size: 12px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
        }

        .course-list {
            flex: 1;
            overflow-y: auto;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
        }

        .course-item {
            background: #fff;
            border: 1px solid var(--border-color);
            padding: 10px;
            padding-left: 35px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            position: relative;
        }

        .course-item::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
        }

        .course-item.selected::before {
            background: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: inset 0 0 0 3px white;
        }

        .course-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .course-item strong { display: block; margin-bottom: 3px; font-size: 0.95rem; }
        .course-item span { font-size: 0.8rem; color: #666; }

        .main-content { flex: 1; padding: 12px; overflow: hidden; height: 100%; min-width: 0; background: white; }
        
        .timetable-card {
            background: white !important;
            padding: 16px;
            border-radius: 12px;
            box-shadow: none;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        table { width: 100% !important; height: 100%; border-collapse: collapse; table-layout: fixed !important; }
        th, td { 
            width: 20% !important;
            box-sizing: border-box !important;
        }
        th:first-child, td:first-child { 
            width: 5% !important; 
        }
        th {
            background: #fef5f5;
            color: #555;
            font-weight: 600;
            padding: 8px;
            border: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        td {
            border: 1px solid var(--border-color);
            vertical-align: top;
            padding: 2px;
            position: relative;
            background: white !important;
        }

        td:first-child { width: 50px; background: #fef5f5 !important; vertical-align: middle; text-align: center; font-size: 0.75rem; color: #8B4049; font-weight: 500; }

        .cell-content {
            font-size: 0.75rem !important;
            padding: 3px;
            border-radius: 8px;
            width: 100%;
            height: 100%;
            max-height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.1 !important;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: all 0.2s;
            overflow: hidden;
            white-space: normal;
            word-break: break-word;
        }
        
        .cell-content:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
        }
        
        .cell-overlap {
            position: relative;
        }
        
        .cell-overlap::before {
            content: 'âš ï¸';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: help;
        }
        
        .cell-overlap::after {
            content: 'ì‹œê°„ ê²¹ì¹¨';
            position: absolute;
            top: -25px;
            right: 0;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10;
        }
        
        .cell-overlap:hover::after {
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 24px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 16px;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin: 0;
            font-weight: 600;
        }

        .modal-body {
            font-size: 0.95rem;
            line-height: 1.8;
            color: #555;
            min-height: auto;
            display: block;
            text-align: left;
        }

        .modal-footer {
            margin-top: 24px;
            text-align: right;
        }

        .modal-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .modal-btn:hover {
            background: #a01d23;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 39, 45, 0.3);
        }

        @media (max-width: 1200px) {
            .app-container {
                flex-direction: column;
                flex-wrap: wrap;
                height: auto;
            }
            
            .sidebar {
                width: 100% !important;
                max-height: 40vh !important;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 10px;
                overflow-y: auto !important;
                order: 1;
            }
            
            .main-content {
                width: 100% !important;
                max-height: 20vh !important;
                height: 20vh !important;
                min-height: 20vh !important;
                padding: 5px !important;
                overflow: hidden !important;
                order: 2;
            }
            
            .timetable-card {
                height: 20vh !important;
                padding: 5px !important;
                overflow: hidden !important;
            }
            
            table {
                height: 20vh !important;
                overflow: hidden !important;
            }
            
            tbody {
                display: block !important;
                max-height: 18vh !important;
                overflow: hidden !important;
            }
            
            tbody tr {
                height: 14px !important;
            }
            
            .selected-panel {
                display: block !important;
                width: 100% !important;
                max-height: 40vh !important;
                border-right: none !important;
                border-bottom: 1px solid var(--border-color);
                padding: 10px;
                overflow-y: auto !important;
                order: 3;
            }
            
            h2 {
                margin-bottom: 8px;
                font-size: 0.95rem;
                display: block !important;
            }
            
            .selected-panel h3 {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }
            
            .filters {
                gap: 4px;
                margin-bottom: 8px;
                display: flex !important;
            }
            
            .filters select {
                font-size: 0.8rem;
                padding: 6px;
                flex: 1;
            }
            
            table { width: 100% !important; height: auto !important; border-collapse: collapse; table-layout: fixed !important; }
            thead { display: none !important; }
            tbody tr { height: 12px !important; }
            td { padding: 2px !important; font-size: 0.5rem !important; }
            th { display: none !important; }
            .cell-content { font-size: 0.5rem !important; padding: 1px !important; height: 12px !important; line-height: 1 !important; }
            
            .course-item {
                font-size: 0.8rem;
                padding: 8px;
                padding-left: 30px;
                margin-bottom: 6px;
            }
            
            .selected-item {
                font-size: 0.8rem;
                padding: 6px;
                margin-bottom: 4px;
            }
            
            .stats-box {
                font-size: 0.75rem;
                padding: 8px;
            }
            
            .save-btn {
                padding: 10px;
                font-size: 0.85rem;
                margin-top: 8px;
            }
        }
    </style>
</head>
<body>

<div id="guideModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ì•ˆë‚´ì‚¬í•­</h2>
        </div>
        <div class="modal-body">
            <div style="text-align: left; width: 100%;">
                <p style="margin: 8px 0;">â€¢ ì™¼ìª½ì—ì„œ ê³¼ëª©ì„ í´ë¦­í•˜ì—¬ ì‹œê°„í‘œì— ì¶”ê°€í•˜ì„¸ìš”.</p>
                <p style="margin: 8px 0;">â€¢ ê²¹ì¹˜ëŠ” ì‹œê°„ì€ âš ï¸ ì•„ì´ì½˜ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                <p style="margin: 8px 0;">â€¢ ì„ íƒí•œ ê³¼ëª©ì€ 'ì €ì¥í•˜ê¸°'ë¡œ ë³´ê´€ë©ë‹ˆë‹¤.</p>
                <p style="margin: 8px 0;">â€¢ ì „ê³µ/í•™ë…„ìœ¼ë¡œ í•„í„°ë§í•˜ì—¬ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <p style="margin: 8px 0;">â€¢ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì—°ë½ ì£¼ì„¸ìš”!</p>
                <p style="margin: 8px 0;">â€¢ ê°œì¸ì ìœ¼ë¡œ ê³µìœ  ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeGuideModal()">ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>
</div>

<div class="app-container">
    <aside class="sidebar">
        <h2>ğŸ“… ì„œìš¸ì˜ˆìˆ ëŒ€í•™êµ ì‹œê°„í‘œ</h2>

        <div class="filters">
            <select id="deptSelect"><option value="">ì „ê³µ ì„ íƒ</option></select>
            <select id="gradeSelect">
                <option value="">í•™ë…„ ì„ íƒ</option>
                <option value="1">1í•™ë…„</option>
                <option value="2">2í•™ë…„</option>
                <option value="3">3í•™ë…„</option>
            </select>
        </div>

        <div id="courseList" class="course-list">
            <p style="text-align:center; color:#999; margin-top:20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</p>
        </div>
    </aside>

    <aside class="selected-panel">
        <h3>âœ“ ì„ íƒí•œ ê³¼ëª©</h3>
        <div id="selectedList" class="selected-list">
            <p style="text-align:center; color:#999; margin-top:20px; font-size:0.85rem;">ê³¼ëª©ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</p>
        </div>
        <div id="statsBox" class="stats-box">
            <div class="stats-row">
                <span>ì´ ìˆ˜ì—…:</span>
                <span id="statCount">0ê°œ</span>
            </div>
            <div class="stats-row">
                <span>ì „í•„:</span>
                <span id="statRequired">0ê°œ</span>
            </div>
            <div class="stats-row">
                <span>ì „ì„ :</span>
                <span id="statElective">0ê°œ</span>
            </div>
            <div class="stats-row">
                <span>ì´ í•™ì :</span>
                <span id="statCredits">0í•™ì </span>
            </div>
        </div>
        <button class="save-btn" onclick="saveCourses()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        <div class="save-status" id="saveStatus"></div>
    </aside>

    <main class="main-content">
        <div class="timetable-card">
            <table>
                <thead>
                    <tr>
                        <th>ì‹œê°„</th>
                        <th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th>
                    </tr>
                </thead>
                <tbody id="timetableBody">
                    </tbody>
            </table>
        </div>
    </main>
</div>

<script>
    let allCourses = [];
    let selectedCourses = [];
    const daysMap = { 'ì›”': 0, 'í™”': 1, 'ìˆ˜': 2, 'ëª©': 3, 'ê¸ˆ': 4 };
    const courseColors = {};
    const prettyColors = [
        { bg: '#FFE5E5', text: '#8B4049' },
        { bg: '#FFF0E0', text: '#8B6914' },
        { bg: '#E8F5E9', text: '#2E7D32' },
        { bg: '#E3F2FD', text: '#1565C0' },
        { bg: '#F3E5F5', text: '#6A1B9A' },
        { bg: '#FFF9C4', text: '#827717' },
        { bg: '#FCE4EC', text: '#AD1457' },
        { bg: '#E0F2F1', text: '#00695C' },
        { bg: '#FBE9E7', text: '#BF360C' },
        { bg: '#E8EAF6', text: '#283593' }
    ];
    let colorIndex = 0;
    
    function getCourseColor(courseName) {
        if (!courseColors[courseName]) {
            courseColors[courseName] = prettyColors[colorIndex % prettyColors.length];
            colorIndex++;
        }
        return courseColors[courseName];
    }

    function closeGuideModal() {
        const modal = document.getElementById('guideModal');
        modal.classList.remove('show');
    }

    function showGuideModal() {
        const modal = document.getElementById('guideModal');
        modal.classList.add('show');
    }

    function getCourseKey(course) {
        return `${course['êµê³¼ëª©ëª…']}|${course['êµìˆ˜ëª…']}|${course['ì›¹ê²Œì‹œì‹œê°„í‘œ']}`;
    }

    function saveCourses() {
        const courseData = selectedCourses.map(sc => ({
            name: sc.course['êµê³¼ëª©ëª…'],
            professor: sc.course['êµìˆ˜ëª…'],
            time: sc.course['ì›¹ê²Œì‹œì‹œê°„í‘œ']
        }));
        console.log('ì €ì¥í•˜ëŠ” ê³¼ëª©:', courseData);
        localStorage.setItem('selectedCourses', JSON.stringify(courseData));
        
        const statusEl = document.getElementById('saveStatus');
        statusEl.textContent = 'âœ“ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (' + courseData.length + 'ê°œ)';
        statusEl.classList.add('success');
        setTimeout(() => {
            statusEl.textContent = '';
            statusEl.classList.remove('success');
        }, 2000);
    }

    function loadSavedCourses() {
        const saved = localStorage.getItem('selectedCourses');
        if (!saved) return [];
        try {
            return JSON.parse(saved);
        } catch {
            return [];
        }
    }

    function restoreCourses(savedCourseData) {
        if (!savedCourseData || savedCourseData.length === 0) return;
        
        savedCourseData.forEach(data => {
            const course = allCourses.find(c => 
                c['êµê³¼ëª©ëª…'] === data.name && 
                c['êµìˆ˜ëª…'] === data.professor && 
                c['ì›¹ê²Œì‹œì‹œê°„í‘œ'] === data.time
            );
            if (course) {
                const existingIndex = selectedCourses.findIndex(sc => 
                    sc.course['êµê³¼ëª©ëª…'] === course['êµê³¼ëª©ëª…'] &&
                    sc.course['êµìˆ˜ëª…'] === course['êµìˆ˜ëª…'] &&
                    sc.course['ì›¹ê²Œì‹œì‹œê°„í‘œ'] === course['ì›¹ê²Œì‹œì‹œê°„í‘œ']
                );
                if (existingIndex < 0) {
                    selectedCourses.push({ index: -1, course });
                }
            }
        });
        
        renderList(window.currentFiltered || allCourses);
        renderSelectedList();
        updateTimetable();
        updateStats();
    }

    const SHEET_ID = '1whjwCYYAwUmovpDQ3wWR7gPkVq8ZaqXOLz9h1xWWpxo';
    const SHEET_GID = '0';
    const PUBLISHED_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSfvViCMHfhK0zZYBqxOkcfR33rV-7CmfBlotyzYEt414CtjYWeButUNLIZXWQ1CIkGJlTppwoqmgVG/pub?output=csv&gid=0';
    const MANUAL_HEADERS = [
        'ì†Œì†', 'í•™ë…„', 'êµê³¼ëª©ëª…', 'ì´ìˆ˜êµ¬ë¶„', 'êµê³¼ êµ¬ë¶„', 'ë¶„ë°˜', 'ì œí•œ ì¸ì›', 'êµìˆ˜ëª…', 'í•™ì ', 'ì‹œ ìˆ˜', '', 'ì›¹ê²Œì‹œì‹œê°„í‘œ'
    ];

    const tbody = document.getElementById('timetableBody');
    for (let i = 1; i <= 14; i++) {
        const row = document.createElement('tr');
        let cells = `<td>${i}</td>`;
        for (let j = 0; j < 5; j++) {
            cells += `<td id="cell-${j}-${i}"></td>`;
        }
        row.innerHTML = cells;
        tbody.appendChild(row);
    }

    function normalizeKey(key) {
        return String(key || '')
            .replace(/^\uFEFF/, '')
            .replace(/\s+/g, '')
            .replace(/[\r\n]/g, '')
            .replace(/[()\[\]{}<>]/g, '')
            .replace(/[:_\-]/g, '')
            .trim();
    }

    function getByKeyIncludes(row, patterns) {
        const keys = Object.keys(row);
        for (const p of patterns) {
            const hit = keys.find(k => k.includes(p));
            if (hit) return row[hit];
        }
        return '';
    }

    function normalizeRow(row) {
        let gradeVal = row['í•™ë…„'] || row['b'] || row['col1'] || '';
        gradeVal = String(gradeVal).replace(/í•™ë…„/g, '').trim();
        
        const mapped = {
            'êµê³¼ëª©ëª…': row['êµê³¼ëª©ëª…'] || row['col2'] || '',
            'êµìˆ˜ëª…': row['êµìˆ˜ëª…'] || row['col7'] || '',
            'ì›¹ê²Œì‹œì‹œê°„í‘œ': row['ì›¹ê²Œì‹œì‹œê°„í‘œ'] || row['col11'] || '',
            'ì†Œì†': row['ì†Œì†'] || row['col0'] || '',
            'í•™ë…„': gradeVal,
            'í•™ì ': String(row['í•™ì '] || row['col8'] || '').trim(),
            'ì œí•œì¸ì›': String(row['ì œí•œ ì¸ì›'] || row['col6'] || '').trim(),
            'ì´ìˆ˜êµ¬ë¶„': String(row['ì´ìˆ˜êµ¬ë¶„'] || row['col3'] || '').trim()
        };
        
        return mapped;
    }

    function sanitizeCourse(course) {
        const cleaned = {
            'êµê³¼ëª©ëª…': String(course['êµê³¼ëª©ëª…'] || '').trim(),
            'êµìˆ˜ëª…': String(course['êµìˆ˜ëª…'] || '').trim(),
            'ì›¹ê²Œì‹œì‹œê°„í‘œ': String(course['ì›¹ê²Œì‹œì‹œê°„í‘œ'] || '').trim(),
            'ì†Œì†': String(course['ì†Œì†'] || '').trim(),
            'í•™ë…„': String(course['í•™ë…„'] || '').trim(),
            'í•™ì ': String(course['í•™ì '] || '').trim(),
            'ì œí•œì¸ì›': String(course['ì œí•œì¸ì›'] || '').trim(),
            'ì´ìˆ˜êµ¬ë¶„': String(course['ì´ìˆ˜êµ¬ë¶„'] || '').trim()
        };

        const isNotice = cleaned['êµê³¼ëª©ëª…'].startsWith('*') || cleaned['êµê³¼ëª©ëª…'].includes('ì´ìˆ˜êµ¬ë¶„');
        const isHeaderLike = cleaned['êµê³¼ëª©ëª…'] === 'í•™ê¸°' || cleaned['êµê³¼ëª©ëª…'] === 'ì†Œì†' || cleaned['êµê³¼ëª©ëª…'] === 'êµê³¼ëª©ëª…';
        const isEmptyInfo = !cleaned['êµìˆ˜ëª…'] && !cleaned['ì›¹ê²Œì‹œì‹œê°„í‘œ'] && !cleaned['ì†Œì†'];

        if ((isNotice || isHeaderLike) && isEmptyInfo) return null;
        if (cleaned['êµê³¼ëª©ëª…'] === 'êµê³¼ëª©' && isEmptyInfo) return null;
        if (cleaned['êµê³¼ëª©ëª…'] === 'êµê³¼ëª©ëª…' && isEmptyInfo) return null;
        if (!cleaned['êµê³¼ëª©ëª…'] && isEmptyInfo) return null;

        return cleaned;
    }

    function sheetToCourses(sheet) {
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
        if (!rows || rows.length === 0) return [];

        console.log('===== ì²« 5ê°œ í–‰ (ì›ë³¸) =====');
        rows.slice(0, 5).forEach((r, i) => console.log(`Row ${i}:`, r));
        const targetHeaders = ['í•™ê¸°', 'ì†Œì†', 'í•™ê³¼', 'í•™ë¶€', 'ì „ê³µ', 'í•™ë…„', 'êµê³¼ëª©ëª…', 'êµê³¼ëª©', 'êµìˆ˜ëª…', 'ì›¹ê²Œì‹œì‹œê°„í‘œ'];
        let headerRowIndex = 0;
        let bestScore = -1;
        let foundRequired = false;

        for (let i = 0; i < rows.length; i++) {
            const normalizedCells = rows[i].map(normalizeKey);
            const filled = normalizedCells.filter(v => v).length;
            if (filled < 2) continue;

            const hasRequired = requiredHeaders.every(h => normalizedCells.some(c => c.includes(normalizeKey(h))));
            const score = targetHeaders.reduce((acc, h) => {
                const hit = normalizedCells.some(c => c.includes(normalizeKey(h)));
                return acc + (hit ? 1 : 0);
            }, 0);

            if (hasRequired) {
                headerRowIndex = i;
                bestScore = score;
                foundRequired = true;
                break;
            }

            if (score > bestScore) {
                bestScore = score;
                headerRowIndex = i;
            }
        }

        let headers = [];
        let dataRows = [];

        if (foundRequired) {
            headers = rows[headerRowIndex].map(normalizeKey);
            dataRows = rows.slice(headerRowIndex + 1);
        } else {
            headers = MANUAL_HEADERS.map(normalizeKey);
            dataRows = rows;
        }

        const raw = dataRows.map(r => {
            const obj = {};
            headers.forEach((h, idx) => {
                const key = h || `col${idx}`;
                obj[key] = r[idx] ?? '';
            });
            return obj;
        });

        const normalized = raw.map(normalizeRow);
        return normalized;
    }

    function parseGvizTable(table) {
        let headers = table.cols.map(c => c.label || c.id || '');
        headers = headers.map(normalizeKey);

        const rows = table.rows.map(r => {
            const obj = {};
            r.c.forEach((cell, idx) => {
                const key = headers[idx] || `col${idx}`;
                obj[key] = cell ? (cell.f ?? cell.v ?? '') : '';
            });
            return obj;
        });

        return rows.map(normalizeRow);
    }

    function loadFromGvizJsonp() {
        return new Promise((resolve, reject) => {
            const timeout = setTimeout(() => reject(new Error('GViz JSONP timeout')), 8000);
            const callbackHolder = {
                setResponse: (resp) => {
                    try {
                        const table = resp.table;
                        const data = parseGvizTable(table);
                        resolve(data);
                    } catch (e) {
                        reject(e);
                    } finally {
                        clearTimeout(timeout);
                        script.remove();
                    }
                }
            };

            window.google = window.google || {};
            window.google.visualization = window.google.visualization || {};
            window.google.visualization.Query = callbackHolder;

            const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${SHEET_GID}&headers=1&tqx=out:json`;
            const script = document.createElement('script');
            script.src = gvizUrl;
            script.onerror = () => {
                clearTimeout(timeout);
                script.remove();
                reject(new Error('GViz JSONP load error'));
            };
            document.body.appendChild(script);
        });
    }

    async function loadFromGoogleSheet() {
        const listDiv = document.getElementById('courseList');

        listDiv.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</p>';

        try {
            try {
                const res = await fetch(PUBLISHED_CSV_URL, { cache: 'no-store' });
                if (!res.ok) throw new Error('published CSV fetch ì‹¤íŒ¨');

                const buffer = await res.arrayBuffer();
                let csvText = '';
                try {
                    csvText = new TextDecoder('utf-8').decode(buffer);
                } catch {
                    csvText = new TextDecoder('euc-kr').decode(buffer);
                }

                if (!csvText.includes('êµê³¼ëª©') && !csvText.includes('í•™ê¸°')) {
                    try {
                        csvText = new TextDecoder('euc-kr').decode(buffer);
                    } catch {
                        // ignore
                    }
                }

                const workbook = XLSX.read(csvText, { type: 'string' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                allCourses = sheetToCourses(sheet);
            } catch {
                allCourses = await loadFromGvizJsonp();
            }
            allCourses = allCourses
                .map(sanitizeCourse)
                .filter(Boolean)
                .filter(c => Object.values(c).some(v => String(v).trim() !== ''));
            if (allCourses.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; padding:20px; color:#d33;">ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì‹œíŠ¸ ì²« í–‰(í—¤ë”)ê³¼ ë°ì´í„° í–‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
                return;
            }
            initFilter();
            renderList(allCourses);
            const savedCourseNames = loadSavedCourses();
            if (savedCourseNames.length > 0) {
                setTimeout(() => restoreCourses(savedCourseNames), 100);
            }
            setTimeout(fitTimetableRows, 0);
        } catch (err) {
            console.error(err);

            listDiv.innerHTML =
                '<p style="text-align:center; padding:20px; color:#d33;">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ â€œì›¹ì— ê²Œì‹œâ€ë¡œ ì„¤ì •í•˜ê±°ë‚˜ ë§í¬ ê³µê°œ ìƒíƒœì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
        }
    }

    function initFilter() {
        const deptSelect = document.getElementById('deptSelect');
        const depts = [...new Set(allCourses.map(c => c['ì†Œì†']).filter(Boolean))];
        
        deptSelect.innerHTML = '<option value="">ì „ê³µ ì„ íƒ</option>';
        if (depts.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'í•™ê³¼ ì •ë³´ ì—†ìŒ';
            opt.disabled = true;
            deptSelect.appendChild(opt);
        } else {
            depts.sort().forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                deptSelect.appendChild(opt);
            });
        }

        deptSelect.onchange = applyFilters;
        document.getElementById('gradeSelect').onchange = applyFilters;
    }

    function applyFilters() {
        const dept = document.getElementById('deptSelect').value;
        const grade = document.getElementById('gradeSelect').value;

        const filtered = allCourses.filter(c => {
            const matchDept = !dept || c['ì†Œì†'] === dept;
            const rawGrade = String(c['í•™ë…„'] || '').replace(/\s+/g, '');
            const matchGrade = !grade || rawGrade.includes(grade) || rawGrade.includes(`${grade}í•™ë…„`);
            return matchDept && matchGrade;
        });

        renderList(filtered);
    }

    function renderList(courses) {
        const listDiv = document.getElementById('courseList');
        if (courses.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center; padding:20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const selectedSet = new Set(selectedCourses.map(sc => 
            `${sc.course['êµê³¼ëª©ëª…']}|${sc.course['êµìˆ˜ëª…']}|${sc.course['ì›¹ê²Œì‹œì‹œê°„í‘œ']}`
        ));

        listDiv.innerHTML = courses.map((c, index) => {
            const credit = c['í•™ì '] ? c['í•™ì '] + 'í•™ì ' : '';
            const type = c['ì´ìˆ˜êµ¬ë¶„'] ? `(${c['ì´ìˆ˜êµ¬ë¶„']})` : '';
            const creditWithType = [credit, type].filter(Boolean).join(' ');
            const capacity = c['ì œí•œì¸ì›'] ? 'ì •ì› ' + c['ì œí•œì¸ì›'] + 'ëª…' : '';
            const infoLine = [creditWithType, capacity].filter(Boolean).join(' | ');
            const courseKey = `${c['êµê³¼ëª©ëª…']}|${c['êµìˆ˜ëª…']}|${c['ì›¹ê²Œì‹œì‹œê°„í‘œ']}`;
            const isSelected = selectedSet.has(courseKey);
            
            return `
            <div class="course-item ${isSelected ? 'selected' : ''}" onclick="toggleCourse(${index})">
                <strong>${c['êµê³¼ëª©ëª…'] || 'ê³¼ëª©ëª… ì—†ìŒ'}</strong>
                <span>${c['êµìˆ˜ëª…'] || 'êµìˆ˜ëª… ì—†ìŒ'} | ${c['ì›¹ê²Œì‹œì‹œê°„í‘œ'] || 'ì‹œê°„ ë¯¸ì§€ì •'}</span>
                <br><small style="color:#aaa">${c['ì†Œì†'] || 'í•™ê³¼ ì •ë³´ ì—†ìŒ'} ${c['í•™ë…„'] ? `(${c['í•™ë…„']}í•™ë…„)` : ''}${infoLine ? ' | ' + infoLine : ''}</small>
            </div>
        `;
        }).join('');
        
        window.currentFiltered = courses;
    }

    // ê³¼ëª© ì„ íƒ/í•´ì œ í† ê¸€
    function toggleCourse(index) {
        const course = window.currentFiltered[index];
        const existingIndex = selectedCourses.findIndex(sc => 
            sc.course['êµê³¼ëª©ëª…'] === course['êµê³¼ëª©ëª…'] &&
            sc.course['êµìˆ˜ëª…'] === course['êµìˆ˜ëª…'] &&
            sc.course['ì›¹ê²Œì‹œì‹œê°„í‘œ'] === course['ì›¹ê²Œì‹œì‹œê°„í‘œ']
        );

        if (existingIndex >= 0) {
            selectedCourses.splice(existingIndex, 1);
        } else {
            selectedCourses.push({ index, course });
        }

        renderList(window.currentFiltered);
        renderSelectedList();
        updateTimetable();
        updateStats();
    }

    function renderSelectedList() {
        const listDiv = document.getElementById('selectedList');
        
        if (selectedCourses.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px; font-size:0.85rem;">ê³¼ëª©ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</p>';
            return;
        }

        listDiv.innerHTML = selectedCourses.map((sc, idx) => {
            const c = sc.course;
            const credit = c['í•™ì '] ? c['í•™ì '] + 'í•™ì ' : '';
            const type = c['ì´ìˆ˜êµ¬ë¶„'] ? `(${c['ì´ìˆ˜êµ¬ë¶„']})` : '';
            const creditWithType = [credit, type].filter(Boolean).join(' ');
            
            const timeData = c['ì›¹ê²Œì‹œì‹œê°„í‘œ'];
            const noTime = !timeData || timeData === 'ì‹œê°„ ë¯¸ì§€ì •' || timeData.includes('ë¯¸ì§€ì •');
            const warningStyle = noTime ? 'background: #fff3cd; border-left: 3px solid #ff9800;' : '';
            const warningIcon = noTime ? '<span style="color: #ff9800; font-weight: bold; margin-right: 4px;">âš ï¸</span>' : '';
            
            return `
            <div class="selected-item" onclick="removeCourse(${idx})" style="${warningStyle}">
                <button class="remove-btn" onclick="event.stopPropagation(); removeCourse(${idx})">Ã—</button>
                <strong>${warningIcon}${c['êµê³¼ëª©ëª…']}</strong>
                <small>${c['êµìˆ˜ëª…']} | ${creditWithType}</small>
                ${noTime ? '<small style="display:block; color:#ff9800; margin-top:3px;">âš ï¸ ì‹œê°„ ë¯¸ì§€ì •</small>' : ''}
            </div>
        `;
        }).join('');
    }

    function removeCourse(idx) {
        selectedCourses.splice(idx, 1);
        renderList(window.currentFiltered);
        renderSelectedList();
        updateTimetable();
        updateStats();
    }

    function updateTimetable() {
        const cellData = {};
        for (let i = 1; i <= 14; i++) {
            for (let j = 0; j < 5; j++) {
                const cell = document.getElementById(`cell-${j}-${i}`);
                if (cell) {
                    cell.innerHTML = '';
                    cellData[`${j}-${i}`] = [];
                }
            }
        }

        selectedCourses.forEach(sc => {
            addCourseToTimetable(sc.course, cellData);
        });
    }

    function addCourseToTimetable(course, cellData) {
        let timeData = course['ì›¹ê²Œì‹œì‹œê°„í‘œ'];

        if (!timeData || timeData === 'ì‹œê°„ ë¯¸ì§€ì •' || timeData.includes('ë¯¸ì§€ì •')) {
            return;
        }

        if (typeof timeData !== 'string') return;

        const dayTimePattern = /[ì›”í™”ìˆ˜ëª©ê¸ˆ]\d+(?:,\d+)*/g;
        const dayTimeSessions = timeData.match(dayTimePattern) || [];
        
        dayTimeSessions.forEach(session => {
            const cleaned = session.trim().replace(/\s+/g, '');
            const dayChar = cleaned[0];
            const dayIndex = daysMap[dayChar];
            let withoutParens = cleaned;
            while (withoutParens.includes('(')) {
                withoutParens = withoutParens.replace(/\([^)]*\)/g, '');
            }
            withoutParens = withoutParens.replace(/\)/g, '');
            const periodText = withoutParens.substring(1);
            const periods = [];
            

            const parts = periodText.split(',').map(p => p.trim()).filter(Boolean);
            
            parts.forEach(part => {
                if (part.includes('-') || part.includes('~')) {
                    const range = part.split(/[-~]/).map(v => v.trim()).filter(Boolean);
                    if (range.length === 2 && !isNaN(range[0]) && !isNaN(range[1])) {
                        const start = parseInt(range[0], 10);
                        const end = parseInt(range[1], 10);
                        for (let p = Math.min(start, end); p <= Math.max(start, end); p++) {
                            periods.push(String(p));
                        }
                    }
                } else if (part && !isNaN(part)) {
                    periods.push(part);
                }
            });

            if (dayIndex !== undefined && periods.length > 0) {
                const colors = getCourseColor(course['êµê³¼ëª©ëª…']);
                periods.forEach(p => {
                    const pNum = p.trim();
                    const cellKey = `${dayIndex}-${pNum}`;
                    const cell = document.getElementById(`cell-${cellKey}`);
                    if (cell && cellData) {
                        cellData[cellKey].push(course['êµê³¼ëª©ëª…']);
                        const isOverlap = cellData[cellKey].length > 1;
                        const overlapClass = isOverlap ? ' cell-overlap' : '';
                        cell.innerHTML = `<div class="cell-content${overlapClass}" style="background: ${colors.bg}; color: ${colors.text};">${course['êµê³¼ëª©ëª…']}</div>`;
                    }
                });
            }
        });
    }

    function updateStats() {
        const totalCount = selectedCourses.length;
        let totalCredits = 0;
        let requiredCount = 0;
        let electiveCount = 0;

        selectedCourses.forEach(sc => {
            const c = sc.course;
            const credit = parseFloat(c['í•™ì ']) || 0;
            totalCredits += credit;

            const type = c['ì´ìˆ˜êµ¬ë¶„'] || '';
            if (type.includes('ì „í•„') || type.includes('í•„ìˆ˜')) {
                requiredCount++;
            } else if (type.includes('ì „ì„ ') || type.includes('ì„ íƒ')) {
                electiveCount++;
            }
        });

        document.getElementById('statCount').textContent = `${totalCount}ê°œ`;
        document.getElementById('statRequired').textContent = `${requiredCount}ê°œ`;
        document.getElementById('statElective').textContent = `${electiveCount}ê°œ`;
        document.getElementById('statCredits').textContent = `${totalCredits}í•™ì `;
    }

    function fitTimetableRows() {
        const card = document.querySelector('.timetable-card');
        const thead = card.querySelector('thead');
        const tbodyEl = card.querySelector('tbody');
        const rows = tbodyEl.querySelectorAll('tr');
        if (!rows.length) return;

        const styles = getComputedStyle(card);
        const padTop = parseFloat(styles.paddingTop) || 0;
        const padBottom = parseFloat(styles.paddingBottom) || 0;
        const cardHeight = card.clientHeight - padTop - padBottom;
        const headHeight = thead.clientHeight;
        const bodyHeight = Math.max(cardHeight - headHeight, 0);
        const rowHeight = Math.max(Math.floor(bodyHeight / rows.length), 40);

        rows.forEach(row => {
            row.style.height = `${rowHeight}px`;
        });
    }

    window.addEventListener('resize', fitTimetableRows);
    window.addEventListener('load', () => {
        showGuideModal();
        loadFromGoogleSheet();
        fitTimetableRows();
    });
</script>

</body>
</html>